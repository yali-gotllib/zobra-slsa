# Universal Container SLSA Workflow
# Generates SLSA Level 3 provenance for container images
# Works with ANY container registry using universal authentication patterns

name: Container SLSA Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to generate provenance for (e.g., container-v1.0.0)'
        required: true
        default: 'container-v1.0.0'
      registry:
        description: 'Container registry (ghcr.io, docker.io, quay.io, etc.)'
        required: false
        default: 'ghcr.io'
        type: string
      dockerfile_path:
        description: 'Path to Dockerfile (default: ./Dockerfile)'
        required: false
        default: './Dockerfile'
        type: string
      build_context:
        description: 'Build context directory (default: .)'
        required: false
        default: '.'
        type: string
      image_name:
        description: 'Full image name (e.g., "johndoe/myapp"). If empty, uses GitHub repository name.'
        required: false
        default: ''
        type: string

permissions:
  contents: read

env:
  IMAGE_REGISTRY: ${{ github.event.inputs.registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.event.inputs.image_name || github.repository }}

jobs:
  # Build and push container image
  build:
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.digest.outputs.digest }}
      registry_username: ${{ steps.registry-creds.outputs.username }}
      registry_password_secret: ${{ steps.registry-creds.outputs.password_secret }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Validate and Configure Image Naming
        run: |
          set -euo pipefail
          echo "Configuring container image naming..."
          
          REGISTRY="${{ env.IMAGE_REGISTRY }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          
          echo "Registry: $REGISTRY"
          echo "Image Name: $IMAGE_NAME"
          
          # Show final image URL
          FULL_IMAGE="$REGISTRY/$IMAGE_NAME"
          echo "Final image will be: $FULL_IMAGE"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Registry Credentials for Provenance
        id: registry-creds
        run: |
          set -euo pipefail
          echo "Determining registry credentials for SLSA provenance..."

          REGISTRY="${{ env.IMAGE_REGISTRY }}"

          # Universal approach: Use the same authentication pattern for ANY registry
          if [ "$REGISTRY" = "ghcr.io" ]; then
            # GitHub Container Registry uses GitHub token
            echo "Using GitHub Container Registry credentials"
            echo "username=${{ github.actor }}" >> "$GITHUB_OUTPUT"
            echo "password_secret=GITHUB_TOKEN" >> "$GITHUB_OUTPUT"
          else
            # ALL other registries use the universal pattern
            echo "Using universal registry credentials for $REGISTRY"
            USERNAME="${{ secrets.REGISTRY_USERNAME }}"
            if [ -z "$USERNAME" ]; then
              echo "ERROR: REGISTRY_USERNAME secret is not configured"
              exit 1
            fi
            echo "username=$USERNAME" >> "$GITHUB_OUTPUT"
            echo "password_secret=REGISTRY_PASSWORD" >> "$GITHUB_OUTPUT"
          fi

          echo "Registry credentials determined for provenance"

      - name: Universal Registry Authentication
        run: |
          set -euo pipefail
          echo "Setting up universal registry authentication..."
          
          REGISTRY="${{ env.IMAGE_REGISTRY }}"
          
          if [ "$REGISTRY" = "ghcr.io" ]; then
            # GitHub Container Registry uses GitHub token
            echo "Authenticating to GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io --username "${{ github.actor }}" --password-stdin
          else
            # ALL other registries use the universal pattern
            echo "Authenticating to $REGISTRY using universal credentials..."
            echo "Using REGISTRY_USERNAME and REGISTRY_PASSWORD secrets"
            
            USERNAME="${{ secrets.REGISTRY_USERNAME }}"
            PASSWORD="${{ secrets.REGISTRY_PASSWORD }}"
            
            if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
              echo "Error: REGISTRY_USERNAME and REGISTRY_PASSWORD secrets must be configured"
              echo "These secrets work for ANY registry: docker.io, quay.io, ECR, ACR, etc."
              exit 1
            fi
            
            echo "$PASSWORD" | docker login "$REGISTRY" --username "$USERNAME" --password-stdin
          fi
          
          echo "Universal registry authentication complete"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.event.inputs.tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        id: build
        with:
          context: ${{ github.event.inputs.build_context || '.' }}
          file: ${{ github.event.inputs.dockerfile_path || './Dockerfile' }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Install crane (if needed)
        run: |
          set -euo pipefail
          echo "🔧 Checking for crane command..."

          if command -v crane >/dev/null 2>&1; then
            echo "✅ crane is already available"
            crane version
          else
            echo "📦 Installing crane..."

            # Detect architecture
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="x86_64" ;;
              aarch64|arm64) ARCH="arm64" ;;
              *) echo "❌ Unsupported architecture: $ARCH"; exit 1 ;;
            esac

            # Get latest crane release
            CRANE_VERSION=$(curl -s https://api.github.com/repos/google/go-containerregistry/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
            echo "📥 Installing crane $CRANE_VERSION for $ARCH..."

            # Download and install crane
            curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_${ARCH}.tar.gz" | tar xz
            sudo mv crane /usr/local/bin/
            sudo chmod +x /usr/local/bin/crane

            echo "✅ crane installed successfully"
            crane version
          fi

      - name: Extract digest
        id: digest
        run: |
          # Get the first tag from the metadata output
          tag=$(echo "${{ steps.meta.outputs.tags }}" | head -1)
          digest=$(crane digest "$tag")
          echo "digest=$digest" >> "$GITHUB_OUTPUT"



      - name: Output image
        id: image
        run: |
          # Set the image as an output
          image_name="${IMAGE_REGISTRY}/${IMAGE_NAME}"
          echo "image=$image_name" >> "$GITHUB_OUTPUT"

      - name: Debug Job Outputs
        run: |
          echo "=== DEBUG: Job Outputs ==="
          echo "registry_username: ${{ steps.registry-creds.outputs.username }}"
          echo "registry_password_secret: ${{ steps.registry-creds.outputs.password_secret }}"
          echo "image: ${{ steps.image.outputs.image }}"
          echo "digest: ${{ steps.digest.outputs.digest }}"

  # Generate SLSA provenance
  provenance:
    needs: [build]
    permissions:
      actions: read
      id-token: write
      packages: write
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build.outputs.image }}
      digest: ${{ needs.build.outputs.digest }}
      registry-username: ${{ needs.build.outputs.registry_username }}
      private-repository: ${{ github.event.repository.private }}
    secrets:
      registry-password: ${{ secrets[needs.build.outputs.registry_password_secret] }}
